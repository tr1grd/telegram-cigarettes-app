<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Каталог сигарет</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .product { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; display: flex; align-items: center; }
    .product img { max-width: 120px; margin-right: 10px; }
    .product button { margin-top: 5px; }
    .quantity { width: 50px; }
    #cart div { margin-bottom: 5px; }
    #cart input { width: 40px; }
    #cart-total { font-weight: bold; margin-bottom: 10px; }
    #cart-buttons { margin-top: 10px; }
    #links { margin-bottom: 20px; }
    #links a { display: block; margin-bottom: 5px; }
  </style>
</head>
<body>
  <h1>Каталог</h1>

  <!-- Ссылки -->
  <div id="links">
    <a href="https://tr1grd.github.io/telegram-cigarettes-app/" target="_blank">
      Открыть Mini App (GitHub Pages)
    </a>
    <a href="https://github.com/tr1grd/Chappy.git" target="_blank">
      Репозиторий на GitHub
    </a>
  </div>

  <div id="catalog"></div>

  <h2>Корзина</h2>
  <div id="cart"></div>
  <div id="cart-total"></div>
  <div id="cart-buttons">
    <button onclick="checkout()">Оформить заказ</button>
    <button onclick="clearCart()">Очистить корзину</button>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();

    const products = [
      {
        name: "Chapman Super Slim Brown",
        price: 15,
        img: "https://www.cigarpro.ru/images/products/sigarety/large/1721225514-sigarety-chapman-super-slim-brown.webp"
      },
      {
        name: "Chapman King Size Gold",
        price: 15,
        img: "https://www.cigarpro.ru/images/products/sigarety/large/1721219535-sigarety-chapman-king-size-gold.webp"
      }
    ];

    const cartItems = [];

    const catalogDiv = document.getElementById("catalog");
    products.forEach((product, index) => {
      const div = document.createElement("div");
      div.className = "product";
      div.innerHTML = `
        <img src="${product.img}" alt="${product.name}">
        <div>
          <strong>${product.name}</strong><br>
          Цена: ${product.price}€<br>
          Кол-во: <input type="number" class="quantity" id="qty${index}" value="1" min="1">
          <button onclick="addToCart(${index})">Добавить в корзину</button>
        </div>
      `;
      catalogDiv.appendChild(div);
    });

    function addToCart(index) {
      const product = products[index];
      const qtyInput = document.getElementById(`qty${index}`);
      const quantity = parseInt(qtyInput.value);
      if (quantity < 1) return alert("Введите количество больше 0");

      const existing = cartItems.find(item => item.name === product.name);
      if (existing) {
        existing.quantity += quantity;
      } else {
        cartItems.push({ name: product.name, price: product.price, quantity });
      }
      renderCart();
    }

    function renderCart() {
      const cartDiv = document.getElementById("cart");
      const totalDiv = document.getElementById("cart-total");
      cartDiv.innerHTML = "";
      if (cartItems.length === 0) {
        cartDiv.innerHTML = "<p>Корзина пуста</p>";
        totalDiv.innerHTML = "";
        return;
      }

      let totalSum = 0;
      cartItems.forEach((item, index) => {
        const lineTotal = item.price * item.quantity;
        totalSum += lineTotal;
        cartDiv.innerHTML += `
          <div>
            ${item.name} — ${item.price}€ × 
            <input type="number" value="${item.quantity}" min="1" onchange="updateQuantity(${index}, this.value)">
            = ${lineTotal}€
            <button onclick="removeFromCart(${index})">❌</button>
          </div>
        `;
      });

      totalDiv.innerHTML = `Итого: ${totalSum}€`;
    }

    function updateQuantity(index, value) {
      const qty = parseInt(value);
      if (qty < 1) return alert("Введите количество больше 0");
      cartItems[index].quantity = qty;
      renderCart();
    }

    function removeFromCart(index) {
      cartItems.splice(index, 1);
      renderCart();
    }

    function clearCart() {
      cartItems.length = 0;
      renderCart();
    }

    function checkout() {
      if (cartItems.length === 0) return alert("Корзина пуста!");

      let totalSum = 0;
      const orderProducts = cartItems.map((item) => {
        const lineTotal = item.price * item.quantity;
        totalSum += lineTotal;
        return {
          name: item.name,
          price: item.price,
          quantity: item.quantity,
          total: lineTotal
        };
      });

      const orderData = {
        username: tg.initDataUnsafe.user?.username || "Неизвестно",
        user_id: tg.initDataUnsafe.user?.id || "Неизвестно",
        total: totalSum,
        products: orderProducts
      };

      Telegram.WebApp.sendData(JSON.stringify(orderData));
      alert("Заказ отправлен!");
      clearCart();
    }
  </script>
</body>
</html>
